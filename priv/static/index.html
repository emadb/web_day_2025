<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="data:;base64,iVBORw0KGgo=" />
    <title>Elixir</title>
    <style>
      body {
        padding-left: 50px;
        padding-right: 50px;
        font-size: large;
        font-family: sans-serif;
      }
    </style>
  </head>
  <body>
    <h1 style="color: #742e9c">Distributed Elixir</h1>
    <fieldset>
      <div>
        <h3>Start new rover</h3>
        Id: <input type="text" id="start_process_id" />
        <button onclick="startRover()">Start</button>
      </div>
    </fieldset>
    <fieldset>
      <div>
        <h3>Send a command</h3>
        Id: <input type="text" id="rover_id" /> Command:
        <input type="text" id="cmd" />
        <button onclick="sendCommand()">Send</button>
      </div>
    </fieldset>
    <fieldset>
      <div>
        <h3>Get state</h3>
        Id: <input type="text" id="rover_state_id" />
        <button onclick="getState()">Get</button>
        <pre id="rover_state"></pre>
      </div>
    </fieldset>
    <div>
      <h3>Info</h3>
      <button onClick="getNodes()">Get Nodes</button>

      <ul id="nodes"></ul>

      <h4 id="processes_node"></h4>
      <ul id="processes"></ul>
    </div>
    <div>
      <h3>Log</h3>
      <pre
        id="log"
        style="
          background-color: #eeeeee;
          width: 100%;
          white-space: pre-wrap;
          word-wrap: break-word;
          overflow-wrap: break-word;
          border: 1px solid #ccc;
          padding: 10px;
        "
      ></pre>
    </div>
  </body>

  <script>
    const socket = new WebSocket("ws://localhost:4000/ws");
    socket.onmessage = (evt) => {
      const data = JSON.parse(evt.data);
      log(data, "CRASHED");
    };

    function log(data, level = "INFO") {
      const log = document.getElementById("log");
      let text = "";
      try {
        text =
          new Date().toISOString() +
          " - " +
          level +
          " " +
          " >> " +
          JSON.stringify(data) +
          "\n" +
          log.innerHTML;
      } catch {
        text = data;
      }
      log.innerHTML = text;
    }

    function startRover() {
      const id = parseInt(document.getElementById("start_process_id").value);
      fetch(`/api/rover`, {
        method: "POST",
        headers: {
          Accept: "application/json",
          "Content-Type": "application/json;charset=UTF-8",
        },
        body: JSON.stringify({ process_id: id }),
      })
        .then((response) => response.json())
        .then((data) => {
          document.getElementById("start_process_id").value = "";
          log(data);
          console.log(data);
        });
    }

    function sendCommand() {
      const id = document.getElementById("rover_id").value;
      const cmd = document.getElementById("cmd").value;
      fetch(`/api/rover/${id}/command`, {
        method: "POST",
        headers: {
          Accept: "application/json",
          "Content-Type": "application/json;charset=UTF-8",
        },
        body: JSON.stringify({ cmd }),
      })
        .then((response) => response.json())
        .then((data) => {
          log(data);
          console.log(data);
        });
    }

    function getState() {
      const id = document.getElementById("rover_state_id").value;
      fetch(`/api/rover/${id}`, {})
        .then((response) => response.json())
        .then((data) => {
          const ul = document.getElementById("rover_state");
          ul.innerHTML = JSON.stringify(data);
          log(data);
        });
    }

    function getNodes() {
      fetch(`/api/nodes`, {})
        .then((response) => response.json())
        .then((data) => {
          const ul = document.getElementById("nodes");
          ul.innerHTML = "";
          log(data);
          data.map((d) => {
            const li = document.createElement("li");
            li.appendChild(document.createTextNode(d));

            li.appendChild(getButton(d));
            ul.appendChild(li);
          });
        });
    }

    function getButton(node) {
      const b = document.createElement("button");
      b.textContent = "Show Processes";
      b.addEventListener("click", () => getProcesses(node));
      return b;
    }

    function getProcesses(node) {
      fetch(`/api/nodes/${node}`, {})
        .then((response) => response.json())
        .then((data) => {
          const title = document.getElementById("processes_node");
          title.innerText = `${node} (${data.length})`;

          const ul = document.getElementById("processes");
          ul.innerHTML = "";
          log(data);
          data.map((d) => {
            const li = document.createElement("li");
            li.appendChild(
              document.createTextNode(
                `${d.id} | pos: [${d.pos}] count: ${d.move_count}`,
              ),
            );
            ul.appendChild(li);
          });
        });
    }
  </script>
</html>
